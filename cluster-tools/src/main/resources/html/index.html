<html>
<head>
    <title>Jahia Cluster Configuration Tool</title>
    <link type="text/css" rel="stylesheet" href="../html/css/main.css"/>
    <link type="text/css" rel="stylesheet" href="css/clusterTool.css"/>
    <script type="text/javascript" src="../jquery/jquery.js"></script>
    <script type="text/javascript" src="../jquery-ui/jquery-ui.min.js"></script>
    <script type="text/javascript" src="../jquery-blockUI/jquery.blockUI.js"></script>
    <script type="text/javascript">

        var viewingJahiaPlugins = false;

        function launchOperation(operationName) {
            $.blockUI();
            $.ajax({
                type:'POST',
                url:"../clusterTool/operation/" + encodeURIComponent(operationName),
                success:function (data) {
                    alert("Operation " + operationName + " executed successfully");
                },
                error:function (jqXHR, textStatus, errorThrown) {
                    alert("Operation " + operationName + " failed with error: " + textStatus);
                }
            });
        }

        function checkConfigurationValid() {
            $.ajax({
                url:"../clusterTool/validConfiguration",
                success:function (data) {
                    loadClusterOperations();
                },
                error:function (jqXHR, textStatus, errorThrown) {
                    // we need to modify configuration
                    alert("Invalid configuration, must configure properly first.");
                }
            });
        }

        function loadClusterOperations() {
            viewingJahiaPlugins = true;
            $.blockUI();
            $.ajax({ url:"../clusterTool/operationList",
                success:function (data) {
                    $(".clusterTool").html("");
                    $(".clusterTool").append("<table class='menuTable'><tbody class='menuTableBody'></tbody></table>");
                    var currentRow = null;
                    $.each(data, function (i, item) {
                        if (i % 5 == 0) {
                            $(".menuTableBody").append("<tr id='menuTableRow-" + i + "' class='menuTableRow'></tr>");
                            currentRow = $("#menuTableRow-" + i);
                        }
                        currentRow.append("<td class='menuTableCell' title='" + item["operationDescription"] + "'><img class='moduleIcon' src='icons/" + encodeURIComponent(item["operationName"]) + ".png'/>" +
                                "<div class='moduleButtons'><a class='operationLink buttons' href='#' id='" + item["operationName"] + "' title='" + item["operationDescription"] + "'>" + item["operationDisplayName"] + "</a>" +
                                "</div>" +
                                "</td>");
                    });

                    $(".operationLink").click(function () {
                        launchOperation($(this).attr("id"));
                        return false;
                    });

                }});

        }

        function updateLogs() {
            $.ajax({ url:"../clusterTool/logs",
                success:function (data) {
                    $.each(data, function (i, item) {
                        $(".logView").append("<pre>" + item + "</pre>");
                    });
                }});
        }

        $(document).ready(function () {
            // do stuff when DOM is ready

            // unblock when ajax activity stops
            $(document).ajaxStop($.unblockUI);

            checkConfigurationValid();

            setInterval(updateLogs, 2000);

        });
    </script>

</head>
<body>
<div class="configToolMainWrapper">
    <h1>Cluster Tool</h1>

    <div class="returnToMainMenuBox"><a href="../html/index.html" class="buttons">Back to main menu</a></div>
    <div class="mainViewPort">
        <div class="clusterTool">
            <table class="menuTable">
                <tbody>
                </tbody>
            </table>

            <h2>Logs</h2>
            <div class="logView">
            </div>
        </div>
    </div>
    <div class="copyrightBlock">(c) 2010-2012 Jahia Ltd.</div>
</div>
</body>
</html>